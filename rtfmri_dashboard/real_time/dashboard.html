<!DOCTYPE html>
<html lang="en">
<head>
    <title>Real-Time Report</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
        }
        .container {
            width: 90%;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }
        h1 {
            margin-bottom: 20px;
        }
        .variable {
            text-align: right;
            margin-bottom: 10px;
        }
        .image {
            margin: 10px 0;
            text-align: left;
        }
        .image img {
            max-width: 100%;
            height: auto;
            display: block;
            margin-bottom: 10px;
        }
        table {
            width: 100%;
            table-layout: fixed;
        }
        td {
            text-align: center;
            padding: 20px; /* Adjust the padding as needed */
        }
        canvas {
            border: 1px solid #ccc;
            width: 100%;
            max-width: 100%;
            height: auto;
            max-height: 300px;
            display: block;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Real-Time Dashboard</h1>
        <div class="variable">
            Contrast: <span id="contrast"></span>
        </div>
        <div class="variable">
            Frequency: <span id="frequency"></span>
        </div>
        <div class="variable">
            Resting State: <span id="resting_state"></span>
        </div>
        <div class="variable">
            Epoch: <span id="epoch"></span>
        </div>
        <table>
            <tr>
                <td class="image" id="referenceImageContainer">
                    <p>Reference Registration:</p>
                    <img id="referenceImage" alt="Registration">
                </td>
                <td class="image" id="volumeImageContainer">
                    <p>Current Volume:</p>
                    <img id="volumeImage" alt="Current Volume">
                </td>
                <td class="image" id="qTableImageContainer">
                    <p>Soft Q-Table:</p>
                    <img id="qTableImage" alt="Soft Q-Table">
                </td>
            </tr>
        </table>
        <div class="image">
            <p>Real-Time Data</p>
            <canvas id="image3Canvas"></canvas>
            <canvas id="rewardCanvas"></canvas>
        </div>
    </div>
    <script src="../../data_in/dependencies/Chart.js"></script>
    <script>
        let myChart = null; // Main chart instance
        let rewardChart = null; // Reward chart instance
        const canvas = document.getElementById('image3Canvas');
        const rewardCanvas = document.getElementById('rewardCanvas');

        function createChart(ctx, type, xTitle, yTitle) {
            return new Chart(ctx, {
                type: type,
                data: {
                    labels: [],
                    datasets: [],
                },
                options: {
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: xTitle,
                            },
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: yTitle,
                            },
                        },
                    },
                },
            });
        }

        const ctx = canvas.getContext('2d');
        const rewardCtx = rewardCanvas.getContext('2d');

        myChart = createChart(ctx, 'line', 'Time', 'Value');
        rewardChart = createChart(rewardCtx, 'line', 'Time', 'Reward Value');

        let previousData = null;

        function updateVariables() {
            // Update charts from log.json
            fetch('../../log/log.json')
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error('Network response was not ok.');
                })
                .then(data => {
                    const latestData = data[data.length - 1];

                    if (JSON.stringify(latestData) !== JSON.stringify(previousData)) {
                        previousData = latestData;

                        document.getElementById('contrast').textContent = latestData.contrast;
                        document.getElementById('frequency').textContent = latestData.frequency;
                        document.getElementById('resting_state').textContent = latestData.resting_state;
                        document.getElementById('epoch').textContent = latestData.epoch;

                        const hrf = JSON.parse(data[0].hrf);
                        let fmriData = JSON.parse(latestData.fmri_data);
                        let noise = JSON.parse(latestData.noise);
                        let length_difference = Math.abs(hrf.length - fmriData.length);

                        if (length_difference > 0) {
                            fmriData = Array(length_difference).fill(0).concat(fmriData);
                        }

                        const reward = JSON.parse(latestData.reward);

                        if (!Array.isArray(hrf) || !Array.isArray(fmriData) || !Array.isArray(reward)) {
                            console.error("Data format is incorrect.");
                            return;
                        }

                        myChart.data.labels = Array.from({ length: hrf.length }, (_, i) => i + 1);
                        myChart.data.datasets = [
                            {
                                label: 'Hypothesis Function',
                                borderColor: 'red',
                                data: hrf,
                            },
                            {
                                label: 'fMRI Data',
                                borderColor: 'blue',
                                data: fmriData,
                            },
                            {
                                label: 'Noise',
                                borderColor: 'Purple',
                                data: noise,
                            },
                        ];
                        myChart.update();

                        rewardChart.data.labels = Array.from({ length: reward.length + 2 }, (_, i) => i + 1);
                        rewardChart.data.datasets = [
                            {
                                label: 'Reward',
                                borderColor: 'green',
                                data: reward,
                            },
                        ];
                        rewardChart.update();
                    }
                })
                .catch(error => console.error('Error updating charts:', error));

            // Update images
            updateImage('../../log/reference.png', 'referenceImage');
            updateImage('../../log/volume.png', 'volumeImage');
            updateImage('../../log/q_table.png', 'qTableImage');
        }

        function updateImage(imagePath, imageId) {
            const img = document.getElementById(imageId);

            fetch(imagePath, { cache: 'no-store' }) // Disable caching for images
                .then(response => {
                    if (response.ok) {
                        return response.blob();
                    }
                    throw new Error('Network response was not ok.');
                })
                .then(blob => {
                    const url = URL.createObjectURL(blob);
                    img.src = url;
                })
                .catch(error => console.error('Error updating image:', error));
        }

        // Make the charts responsive
        window.addEventListener('resize', () => {
            myChart.resize();
            rewardChart.resize();
        });

        // Initial call
        updateVariables();

        // Periodic update
        setInterval(updateVariables, 1000); // Adjust the interval as needed
    </script>
</body>
</html>
