<!DOCTYPE html>
<html lang="en">
<head>
    <title>Real-Time Report</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f4f4f4;
        }
        .container {
            width: 80%;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        h1 {
            margin-bottom: 20px;
        }
        .variable {
            text-align: right;
        }
        .image {
            margin: 10px;
            text-align: left;
        }
        .image img {
            width: 100%;
            max-width: 600px;
        }
        canvas {
            border: 1px solid #ccc;
            max-width: 100%;
            max-height: 300px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Real-Time Dashboard</h1>
        <div class="variable">
            Contrast: <span id="contrast"></span>
        </div>
        <div class="variable">
            Frequency: <span id="frequency"></span>
        </div>
        <div class="variable">
            Resting State: <span id="resting_state"></span>
        </div>
        <div class="variable">
            Epoch: <span id="epoch"></span>
        </div>
        <div class="image">
            <p>Reference Registration:</p>
            <img src="../../log/reference.png" alt="Registration">
        </div>
        <div class="image">
            <p>Current Volume:</p>
            <img src="../../log/volume.png" alt="Current Volume">
        </div>
        <div class="image">
            <p>Real-Time Data</p>
            <canvas id="image3Canvas" width="160" height="80"></canvas>
            <canvas id="rewardCanvas" width="160" height="80"></canvas>
        </div>
    </div>
    <script src="../../data_in/dependencies/Chart.js"></script>
    <script>
        let myChart = null; // Main chart instance
        let rewardChart = null; // Reward chart instance
        const canvas = document.getElementById('image3Canvas');
        const rewardCanvas = document.getElementById('rewardCanvas');

        function createChart(ctx, type, xTitle, yTitle) {
            return new Chart(ctx, {
                type: type,
                data: {
                    labels: [],
                    datasets: [],
                },
                options: {
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: xTitle,
                            },
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: yTitle,
                            },
                        },
                    },
                },
            });
        }

        const ctx = canvas.getContext('2d');
        const rewardCtx = rewardCanvas.getContext('2d');

        myChart = createChart(ctx, 'line', 'Time', 'Value');
        rewardChart = createChart(rewardCtx, 'line', 'Time', 'Reward Value');

        function updateVariables() {
            // Fetch and update the data
            fetch('../../log/log.json')
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error('Network response was not ok.');
                })
                .then(data => {
                    const latestData = data[data.length - 1];

                    document.getElementById('contrast').textContent = latestData.contrast;
                    document.getElementById('frequency').textContent = latestData.frequency;
                    document.getElementById('resting_state').textContent = latestData.resting_state;
                    document.getElementById('epoch').textContent = latestData.epoch;

                    const hrf = JSON.parse(data[0].hrf);
                    let fmriData = JSON.parse(latestData.fmri_data);
                    let length_difference = Math.abs(hrf.length - fmriData.length);

                    console.log(length_difference);
                    if (length_difference > 0) {
                        fmriData = Array(length_difference).fill(0).concat(fmriData);
                    }

                    const reward = JSON.parse(latestData.reward);

                    if (!Array.isArray(hrf) || !Array.isArray(fmriData) || !Array.isArray(reward)) {
                        console.error("Data format is incorrect.");
                        return;
                    }

                    myChart.data.labels = Array.from({ length: hrf.length }, (_, i) => i + 1);
                    myChart.data.datasets = [
                        {
                            label: 'HRF',
                            borderColor: 'red',
                            data: hrf,
                        },
                        {
                            label: 'fMRI Data',
                            borderColor: 'blue',
                            data: fmriData,
                        },
                    ];
                    myChart.update();

                    rewardChart.data.labels = Array.from({ length: reward.length + 2 }, (_, i) => i + 1);
                    rewardChart.data.datasets = [
                        {
                            label: 'Reward',
                            borderColor: 'green',
                            data: reward,
                        },
                    ];
                    rewardChart.update();
                })
                .catch(error => console.error('Error:', error));
        }

        setInterval(updateVariables, 5000)
        // updateVariables();
    </script>
</body>
</html>
